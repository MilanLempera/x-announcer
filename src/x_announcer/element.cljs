(ns x-announcer.element
  (:require [lucuma.core :as l]
            [crate.core :as crate]
            [goog.dom :as gdom]
            [goog.events :as gevents]
            [x-announcer.form :as form]
            [x-announcer.store :as store])
  (:import [goog.events EventType]))

(enable-console-print!)


(def icon-class "x-announcer-icon")

; TODO autoconversion
(def icon-datauri "data:image/png;base64,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")

(defn simple-icon []
  (crate/html [:img.bug {:src   icon-datauri
                         :width 50
                         :title "Report bug"
                         :class icon-class}]))

(defn on-created [element properties]
  (store/firebase-settings!
    (:firebase-url properties)
    (:firebase-path properties))

  (let [icon (simple-icon)]
    (gdom/appendChild element icon)
    (gevents/listen icon EventType.CLICK (partial form/toggle element))))

(defn on-detached [element]
  (gevents/unlisten element EventType.CLICK (partial form/toggle element)))

(l/defcustomelement x-announcer
                    :on-created on-created
                    :on-detached on-detached
                    :properties {:firebase-url  "https://shining-fire-1263.firebaseio.com/"
                                 :firebase-path "reports"})

(l/register x-announcer)
